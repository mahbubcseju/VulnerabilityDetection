#!/bin/python

import os
import json
import random


path = '/home/mdrahman/Desktop/pronto/SliceLevelVulnerabilityDetection/' # path of the project directory



def read_data(path):
    f = open(path, 'r')
    data = []
    for sample in f.read().split("\n"):
        try:
            data.append(json.loads(sample))
        except:
            print(sample)
    f.close()
    return data


def write_data(path, data):
    f = open(path, 'w')
    data_ = []
    for sample in data:
        if 'function' not in sample:
            continue
        sample['target'] = sample['label']
        sample['func'] = sample['function']
        sample['idx'] = sample['id']
        del sample['label']
        del sample['function']
        del sample['id']
        data_.append(json.dumps(sample))
    f.write("\n".join(data_))
    f.close()


def check_and_make_dir(path_):
    dirs_ = path_.split()
    path = ''
    for folder in dirs_:
        path = os.path.join(path, folder)
        if not os.path.exists(path):
            os.makedirs(path)

data_folder = os.path.join(path, 'data/D2A/full_jsonl')
for folder in os.listdir(data_folder):
    label_0_path = os.path.join(data_folder, folder, 'labeler_0.jsonl')
    label_1_path = os.path.join(data_folder, folder, 'labeler_1.jsonl')

    vul_data = read_data(label_1_path)
    non_vul_data = read_data(label_0_path)
    random.shuffle(non_vul_data)
    non_vul_data = non_vul_data[:2 * len(vul_data)]

    print(folder, '# Vul =', len(vul_data), '# Non-Vul = ', len(non_vul_data))

    target_folder = os.path.join(path, 'data/D2A/balanced_jsonl', folder)
    check_and_make_dir(target_folder)
    write_data(os.path.join(target_folder, 'vul.jsonl'), vul_data)
    write_data(os.path.join(target_folder, 'non_vul_jsonl'), non_vul_data)



